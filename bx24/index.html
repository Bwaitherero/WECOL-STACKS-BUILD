<!DOCTYPE html>
<html>
<head>
    BX24 Rest Calls
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
<script src="//api.bitrix24.com/api/v1/"></script>
</head>
<body>
</body>
</html>
<script type="text/javascript">

    BX24.init(function() {

        console.log('Init done!', BX24.isAdmin());
        
        });
    

    var userId = 1;
    BX24.callMethod('user.current', {}, function(result) {
        userId = result.data().ID;
        console.info(result.data());

    });

    BX24.callMethod(
            "crm.requisite.fields", 
            {}, 
            function(result) 
            {
                if(result.error())
                    console.error(result.error());
                else
                    console.dir(result.data());
            }
        );

    BX24.callMethod(
        "crm.requisite.bankdetail.fields", 
        {}, 
        function(result) 
        {
            if(result.error())
                console.error(result.error());
            else
                console.dir(result.data());
        }
    );

    //Search bank details by the Entity ID
    var ID = userId;
    BX24.callMethod(
            "crm.requisite.bankdetail.list", 
            { 
                order: { "DATE_CREATE": "ASC" },
                filter: { "ENTITY_ID": userId},
                select: [ "ID", "NAME"]				
            }, 
            function(result) 
            {
                if(result.error())
                    console.error(result.error());
                else
                {
                    console.dir(result.data());			
                    if(result.more())
                        result.next();						
                }
            }
        );

    var bankId = ID;
    BX24.callMethod(
        "crm.requisite.bankdetail.get", 
        { id: bankId }, 
        function(result) 
        {
            if(result.error())
                console.error(result.error());
            else
                console.info(userId);
                console.dir(result.data());
        }
    );

    var id = prompt("Enter ID of Bank Details to Update");
    var entityId = prompt("Enter Y/N to Update Active Status");
    BX24.callMethod(
        "crm.requisite.bankdetail.update", 
        { 
            id: id,
            fields:
            { 
                "ENTITY_ID": 8,
                "ACTIVE" : entityId
            }		
        }, 
        function(result) 
        {
            if(result.error())
                console.error(result.error());
            else
            {
                console.info(result.data());						
            }
        }
    );

    BX24.callMethod(
        "crm.requisite.bankdetail.add", 
        {
            fields:
            { 
                "ENTITY_ID": 1,
                "COUNTRY_ID":1,
                "NAME":"Bank details",
                "XML_ID":"1e4641fd-2dd9-31e6-b2f2-105056c00008",
                "ACTIVE":"Y",
                "SORT":100			
            }
        }, 
        function(result) 
        {
            if(result.error())
                console.error(result.error());
            else
                console.info("Bank details with ID is created" + result.data());
        }
    );

// The ERC-20 ABI
var abi = [
  "function balanceOf(address owner) view returns (uint)",
  "function transfer(address to, uint amount)",
  "event Transfer(address indexed from, address indexed to, uint amount)"
];
// Connect to the Ethereum mainnet
var provider = ethers.providers.getDefaultProvider('homestead');
// Load our wallet and connect to the provider
var wallet = new ethers.Wallet(privateKey, provider);
// Connect to "Pi Day N00b token" Contract (ERC-20 compliant)
var address = "0x334eec1482109bd802d9e72a447848de3bcc1063";
var contract = new ethers.Contract(address, abi, wallet);
// Listen for Transfer events (triggered after the transaction)
contract.ontransfer = function(from, to, amount) {
    var text = ethers.utils.formatEther(amount);
    console.log("Transfer");
    console.log("  From:   ", from);
    console.log("  To:     ", to);
    console.log("  Amount: ", text);
    // Transfer
    //  From:   0x59DEa134510ebce4a0c7146595dc8A61Eb9D0D79
    //  To:     0x851b9167B7cbf772D38eFaf89705b35022880A07
    //  Amount: 1.0
}
// Get the balance of the wallet before the transfer
contract.balanceOf(wallet.address).then(function(balance) {
    var text = ethers.utils.formatEther(balance);
    console.log("Balance Before:", text);
    // Balance Before: 3.141592653589793238
})
// Transfer 1.0 token to another address (we have 18 decimals)
var targetAddress = "0x851b9167B7cbf772D38eFaf89705b35022880A07";
var amount = ethers.utils.parseUnits('1.0', 18);
contract.transfer(targetAddress, amount).then(function(tx) {
    // Show the pending transaction
    console.log(tx);
    // {
    //     hash: 0x820cc57bc7...0dbe181ba1,
    //     gasPrice: BigNumber("0x2540be400"),
    //     gasLimit: BigNumber("0x16e360"),
    //     value: BigNumber("0x0"),
    //     data: "0xa9059cbb" + 
    //           "000000000000000000000000851b9167" +
    //           "b7cbf772d38efaf89705b35022880a07" +
    //           "00000000000000000000000000000000" +
    //           "00000000000000000de0b6b3a7640000",
    //     to: "0x334eec1482109Bd802D9e72A447848de3bCc1063",
    //     v: 37,
    //     r: "0x3fce72962a...a19b611de2",
    //     s: "0x16f9b70010...0b67a5d396",
    //     chainId: 1
    //     from: "0x59DEa134510ebce4a0c7146595dc8A61Eb9D0D79"
    // }
    // Wait until the transaction is mined...
    return tx.wait();
}).then(function(tx) {
    console.log('Mined Transaction in block: ', tx.blockNumber);
    // Get the balance of the wallet after the transfer
    contract.balanceOf(wallet.address).then(function(balance) {
        var text = ethers.utils.formatUnits(balance, 18);
        console.log("Balance After:", text);
        // Balance After: 2.141592653589793238
    })
});

BBX24.callBatch({
        get_user: ['user.current', {}],
        get_department: {
            method: 'department.get',
            params: {
                ID: '$result[get_user][UF_DEPARTMENT]'
            }
        }
}, function(result)
    {
        var l = result.get_department.data().length;
        var str = 'The current user ' + result.get_user.data().NAME + ' ' + 
                                        result.get_user.data().LAST_NAME + 
                                        ' belongs to the following department' + 
                                        (l > 1 ? 's ' : ' ');

        for (var i = 0; i < l; i++)
        {
            str += i == 0 ? '' : ', ';
            str += result.get_department.data()[i].NAME;
        }

        alert(str);
    }
);


</script>
